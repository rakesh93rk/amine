<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Levi Interior - Attendance</title>

<style>
@import url('https://fonts.googleapis.com/css2?family=SF+Pro+Display:wght@400;500;600;700&display=swap');

body{
  font-family:'SF Pro Display',sans-serif;
  background:linear-gradient(180deg,#e0e7ff 0%,#fff 100%);
  min-height:100vh;
  display:flex;
  justify-content:center;
  align-items:center;
}

.app-container{
  width:100%;
  max-width:460px;
  background:white;
  border-radius:28px;
  box-shadow:0 10px 25px rgba(0,0,0,0.1);
  padding:30px 20px;
  text-align:center;
}

.logo{
  width:100px;
  border-radius:20px;
  background:#2563eb;
  padding:4px;
}

h1{margin:15px 0;}

.card{
  background:#f9f9ff;
  padding:16px;
  border-radius:18px;
  margin-top:14px;
}

.btn{
  width:100%;
  padding:14px;
  border-radius:16px;
  border:none;
  font-weight:600;
  margin-top:10px;
  cursor:pointer;
}

.btn-in{background:#e8fdf2;color:#14532d;}
.btn-upload{background:#f1f5f9;color:#1e293b;}
.btn-final{background:#ef4444;color:white;display:none;}

.preview{
  width:120px;
  height:120px;
  object-fit:cover;
  margin-top:10px;
  border-radius:14px;
  display:none;
  border:2px solid #2563eb;
}

.work-previews img{
  width:120px;
  height:120px;
  object-fit:cover;
  margin-top:8px;
  border-radius:12px;
  border:1px solid #ccc;
}

.photo-row{
  display:flex;
  justify-content:space-around;
  gap:10px;
}

.small{font-size:13px;color:#555;margin-top:6px;}

.toast{
  position:fixed;
  top:20px;
  left:-320px;
  background:#22c55e;
  color:white;
  padding:12px 18px;
  border-radius:12px;
  font-weight:600;
  box-shadow:0 5px 15px rgba(0,0,0,0.2);
  transition:left 0.5s ease;
  z-index:9999;
}
.toast.show{left:20px;}
</style>
</head>

<body>

<div id="toast" class="toast"></div>

<div class="app-container">

<img src="https://i.imgur.com/284Ol04.jpeg" class="logo">
<h1>Attendance</h1>

<div class="card">
<button class="btn btn-in" onclick="checkIn()">üü¢ Check In</button>
<button class="btn btn-upload" onclick="uploadWorkPhotos()">üì∏ Upload Work Photos</button>
<button class="btn btn-final" id="finalCheckoutBtn" onclick="finalCheckout()">üî¥ Checkout</button>
</div>

<div class="card">

<div class="photo-row">
  <div>
    <b>Check-In</b><br>
    <img id="checkinPhotoPreview" class="preview">
  </div>
  <div>
    <b>Checkout</b><br>
    <img id="checkoutPhotoPreview" class="preview">
  </div>
</div>

<div id="workPreviewBox" class="work-previews"></div>

<div id="checkinInfo" class="small"></div>
<div id="checkoutInfo" class="small"></div>
</div>

</div>

<script>
let checkInTime=null;
let checkOutTime=null;
let checkInCoords=null;
let workPhotosUploaded=false;
let zoneTimer=null;
let isCheckedIn=false;

/* TOAST */
function showToast(msg){
  const t=document.getElementById("toast");
  t.innerText=msg;
  t.classList.add("show");
  setTimeout(()=>{t.classList.remove("show");},3000);
}

/* CHECK IN */
function checkIn(){
  if(isCheckedIn){
    showToast("‚ö†Ô∏è You are already checked in");
    return;
  }
  takeSelfie("checkin", ()=>getLocation(true));
}

/* SELFIE */
function takeSelfie(type, callback){
  const input=document.createElement("input");
  input.type="file";
  input.accept="image/*";
  input.capture="camera";
  input.onchange=e=>{
    if(!e.target.files[0]) return;
    const reader=new FileReader();
    reader.onload=()=>{
      const img = type==="checkin"
        ? document.getElementById("checkinPhotoPreview")
        : document.getElementById("checkoutPhotoPreview");
      img.src=reader.result;
      img.style.display="block";
      if(callback) callback();
    };
    reader.readAsDataURL(e.target.files[0]);
  };
  input.click();
}

/* WORK PHOTOS */
function uploadWorkPhotos(){
  if(!checkInCoords){
    showToast("‚ö†Ô∏è Please check in first");
    return;
  }

  const input=document.createElement("input");
  input.type="file";
  input.accept="image/*";
  input.multiple=true;

  input.onchange=e=>{
    const box=document.getElementById("workPreviewBox");
    box.innerHTML="";
    Array.from(e.target.files).forEach(f=>{
      const r=new FileReader();
      r.onload=()=>{
        const img=document.createElement("img");
        img.src=r.result;
        box.appendChild(img);
      };
      r.readAsDataURL(f);
    });

    workPhotosUploaded=true;
    document.getElementById("finalCheckoutBtn").style.display="block";
    showToast("üì∏ Work photos uploaded");
  };

  input.click();
}

/* SHORT ADDRESS */
function shortAddress(addr){
  if(!addr) return "Unknown area";
  return [
    addr.road || addr.neighbourhood || addr.suburb || "",
    addr.city || addr.town || addr.village || ""
  ].filter(Boolean).join(", ");
}

/* CHECKOUT */
function finalCheckout(){
  if(!isCheckedIn){
    showToast("‚ö†Ô∏è Please check in first");
    return;
  }
  if(!workPhotosUploaded){
    showToast("‚ö†Ô∏è Upload work photos first");
    return;
  }
  takeSelfie("checkout", ()=>getLocation(false));
}

/* LOCATION */
function getLocation(isCheckIn){
  navigator.geolocation.getCurrentPosition(function(pos){
    const lat=pos.coords.latitude;
    const lng=pos.coords.longitude;
    const now=new Date();

    fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}`,{
      headers:{'User-Agent':'Levi-Attendance-App'}
    })
    .then(r=>r.json())
    .then(d=>{
      const addr = shortAddress(d.address);

      if(isCheckIn){
        checkInTime=now;
        checkInCoords={lat,lng};
        isCheckedIn=true;

        document.getElementById("checkinInfo").innerHTML=
          "üü¢ Check-in<br>"+
          "üïí "+checkInTime.toLocaleString()+"<br>"+
          "üìç "+addr;

        showToast("‚úÖ Check-in successful");

        if(zoneTimer) clearInterval(zoneTimer);
        zoneTimer=setInterval(checkWorkingZone,60000);

      }else{
        checkOutTime=now;

        document.getElementById("checkoutInfo").innerHTML=
          "üî¥ Check-out<br>"+
          "üïí "+checkOutTime.toLocaleString()+"<br>"+
          "üìç "+addr;

        showToast("üî¥ Checkout successful");
      }
    });
  },
  function(){
    showToast("‚ùå Please allow location permission");
  });
}

/* ZONE CHECK (200m notify admin only) */
function checkWorkingZone(){
  navigator.geolocation.getCurrentPosition(function(pos){
    const dist=getDistance(
      checkInCoords.lat,
      checkInCoords.lng,
      pos.coords.latitude,
      pos.coords.longitude
    );

    if(dist>0.2){
      fetch("notify-admin.php",{
        method:"POST",
        headers:{"Content-Type":"application/x-www-form-urlencoded"},
        body:"message=Staff outside 200m work zone"
      });
    }
  });
}

/* DISTANCE */
function getDistance(lat1,lon1,lat2,lon2){
  const R=6371;
  const dLat=(lat2-lat1)*Math.PI/180;
  const dLon=(lon2-lon1)*Math.PI/180;
  const a=Math.sin(dLat/2)**2+
    Math.cos(lat1*Math.PI/180)*Math.cos(lat2*Math.PI/180)*
    Math.sin(dLon/2)**2;
  return R*2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a));
}
</script>

</body>
</html>
